var Chatter=function(){function e(){var e=t.msgbox.val();t.emojis.forEach(function(n,t){e=e.replace(new RegExp("("+n.value+")(?:(?!</))(s)?","gu"),"<i class='em "+n.css+"'>"+n.value+"</i>")});var n=e.match(o);if(null==n&&(n=[]),n.length>0){var a=void 0==n[3]?"<a href='http://$&' target='_blank'>$&</a>":"<a href='$&' target='_blank'>$&</a>";e=e.replace(o,a)}t.previewbox.html(e)}this.VERSION="1.2.2",this.loaded=!1,this.settings=chrome.storage.local,this.enabled;var n=!1;this.updateloop,this.user_count=0,this.colors=["YellowGreen","SteelBlue","Crimson","LimeGreen","CornflowerBlue","Violet","LightSkyBlue","SaddleBrown","DarkOrange","SeaGreen","MediumVioletRed","DarkTurquoise","Olive","Tomato","DarkOliveGreen","Turquoise","DarkRed","Purple","Maroon","RebeccaPurple","DarkCyan","MediumBlue","HotPink","DeepPink","CadetBlue","PaleVioletRed","DarkOrchid","MediumPurple","Brown","DeepSkyBlue","DodgerBlue","SlateBlue","OliveDrab","OrangeRed","Coral","Chocolate","Red","LightCoral","FireBrick","LightSeaGreen","MediumSlateBlue","DarkMagenta","Teal","Orchid","MidnightBlue","Orange","MediumAquaMarine","Green","DarkSalmon","DarkBlue","Navy","DarkGoldenRod","Fuchsia","SkyBlue","ForestGreen","MediumSeaGreen","DarkViolet","RosyBrown","DarkSlateBlue","DarkSeaGreen","RoyalBlue","DarkGreen","MediumOrchid","BlueViolet"],this.color_map={},this.emojis=[{name:"thumb_up",css:"em-thumbsup",unicode:"&#1F44D;",value:"👍"},{name:"thumb_down",css:"em-thumbsdown",unicode:"&#1F44E;",value:"👎"},{name:"gesture_raised_hand",css:"em-raised_hand",unicode:"&#1F44B;",value:"👋"},{name:"face_angry",css:"em-angry",unicode:"&#128544;",value:"😠"},{name:"face_confused",css:"em-confused",unicode:"&#128533;",value:"😕"},{name:"face_confounded",css:"em-confounded",unicode:"&#128534;",value:"😖"},{name:"face_cry",css:"em-cry",unicode:"&#128557;",value:"😭"},{name:"face_disappointed",css:"em-disappointed",unicode:"&#128549;",value:"😥"},{name:"face_expressionless",css:"em-expressionless",unicode:"&#128529;",value:"😑"},{name:"face_frowning",css:"em-frowning",unicode:"&#128577;",value:"🙁"},{name:"face_joy",css:"em-joy",unicode:"&#128514;",value:"😂"},{name:"face_neutral",css:"em-neutral_face",unicode:"&#128528;",value:"😐"},{name:"face_gasp",css:"em-open_mouth",unicode:"&#128562;",value:"😲"},{name:"face_smile",css:"em-smile",unicode:"&#128522;",value:"😊"},{name:"face_smirk",css:"em-smirk",unicode:"&#128527;",value:"😏"},{name:"face_sweat",css:"em-sweat_smile",unicode:"&#128517;",value:"😅"},{name:"face_tongue",css:"em-stuck_out_tongue",unicode:"&#128539;",value:"😛"},{name:"face_tongue_eyes",css:"em-stuck_out_tongue_closed_eyes",unicode:"&#128541;",value:"😝"},{name:"face_tongue_wink",css:"em-stuck_out_tongue_winking_eye",unicode:"&#128540;",value:"😜"},{name:"face_worried",css:"em-worried",unicode:"&#128543;",value:"😟"},{name:"item_date",css:"em-date",unicode:"&#128197;",value:"📅"},{name:"item_chicken",css:"em-chicken",unicode:"&#128020;",value:"🐔"}],this.emoji_css="<style type='text/css'>i.em{font-size:14px;color:transparent;font-style:normal;}div#previewbox{background-color:#f9f9f9;background:linear-gradient(100deg, #f9f9f9 40%,#dedede 50%,#f9f9f9 60%);background-size:1% 25%;border-radius:5px;border:solid 1px #c0c0c0;min-height:4em;max-height:8em;overflow-y:auto;width:80%;padding:2px 6px;white-space:pre-wrap;line-height:1.25;}div#emoji_palette{border:solid 1px black;background-color:#ECECEC;display:none;}div#emoji_palette.open{display:block;}div#emoji_palette button{margin:5px;}</style>",this.document_root,this.iframe,this.userlist,this.msglist,this.msgbox,this.previewbox,this.btnsend,this.chkEnterToSend;var t=this,o=new RegExp(/(((http(?:s)?):(?:\/\/)?(?:[\-;:&=\+\$,\w]+@)?[\w\.\-]+|(?:www\.|[\-;:&=\+\$,\w]+@)[\w\.\-]+)((?:\/[\+~%\/\.\w\-_]*)?\??(?:[\-\+=&;%@\.\w_]*)#?(?:[\.\!\/\\\w\-:?=&;~%#]*))?)/);this.start=function(){t.checkEnabled(),setTimeout(function(){t.setup(),n=!0},5e3),chrome.runtime.onMessage.addListener(function(e,n,o){"toggle_module"==e.action&&(t.checkEnabled(),o("checkEnabled"))})},this.setup=function(){if(t.enabled&&(t.iframe=$("iframe").contents(),t.document_root=t.iframe.find("html"),t.userlist=t.iframe.find("#userlst_id"),t.msglist=t.iframe.find("#msglst_id"),t.msgbox=t.iframe.find("#d2l_form textarea"),t.btnsend=t.iframe.find("#d2l_form a[id*=z_]"),0!=t.userlist.length||0!=t.msglist.length||(t.document_root=$("html"),t.userlist=$("#userlst_id"),t.msglist=$("#msglst_id"),t.msgbox=$("#d2l_form textarea"),t.btnsend=$("#d2l_form a[id*=z_]"),0!=t.userlist.length||0!=t.msglist.length))){$("iframe").css("min-height","720px"),t.document_root.find("head").append("<link href='https://afeld.github.io/emoji-css/emoji.css' rel='stylesheet'>"),t.document_root.find("head").append(t.emoji_css);var n=$("<div id='snd_wrap' style='display:inline-block;'></div>");t.btnsend.wrap(n),n=t.document_root.find("#snd_wrap"),t.chkEnterToSend=$("<input type='checkbox' name='enter_to_send' id='enter_to_send' />").insertAfter(t.btnsend),$("<label for='enter_to_send'>Enter to Send</label>").insertAfter(t.chkEnterToSend),$("</br>").insertAfter(t.btnsend),t.previewbox=$("<div id='previewbox'><div>"),t.previewbox.insertAfter(n),t.btnsend.on("click",function(){t.previewbox.html("")}),$("<div>Preview:</div>").insertBefore(t.previewbox);var o=$("<button><i class='em em-grinning'></i></button>"),a=$("<div id='emoji_palette'></div>");$(o).insertAfter(t.previewbox),o.on("click",function(){a.hasClass("open")?a.removeClass("open"):a.addClass("open")}),$(a).insertAfter(o);var i="",s="<br>";t.emojis.forEach(function(e,n){i+="<button title='"+e.name+"'><i class='em "+e.css+"'></i></button>",(n+1)%13==0&&(i+=s)}),$(a).append(i),$(a).find("button").each(function(n,o){$(o).on("click",function(){var o=t.msgbox.val(),a=t.msgbox[0].selectionStart,i=o.substring(0,a),s=o.substring(a),r=t.emojis[n].value+" ";t.msgbox.val(i+r+s),e(),t.msgbox.focus(),t.msgbox[0].selectionStart=a+r.length,t.msgbox[0].selectionEnd=a+r.length})}),t.msgbox.on("keyup",function(n){13==n.which&&1==t.chkEnterToSend.prop("checked")&&t.btnsend[0].click(),e()}),t.userlist.find("li").each(function(e,n){var o=$(n).text(),a=t.colors[t.user_count];t.color_map[o]=a,t.user_count++}),t.userlist.find("li span").each(function(e,n){var o=$(n).text();$(n).prop("style","color:"+t.color_map[o])}),t.msglist.find("div").each(function(e,n){$(n).prop("style","white-space:pre-wrap;background-color:#EFEFEF;margin:5px 0;padding:5px;border-radius:10px;")}),t.msglist.find("div span > h3 > span").each(function(e,n){var o=$(n).text().replace(":","");$(n).prop("style","font-weight:bold;color:"+t.color_map[o])}),t.userlist.on("contentChanged",t.pollUsers),t.msglist.on("contentChanged",t.pollMessages),t.loaded=!0,t.update()}};var a,i;this.update=function(){s.log("Plato Enhancement Suite: Chatter has started!"),chrome.runtime.sendMessage({action:"update_popup_from_module"},null),t.updateloop=setInterval(function(){var e=t.userlist,n=t.msglist.children().length;a!==e.html()&&(a=e.html(),t.userlist.trigger("contentChanged")),i!==n&&(i=n,t.msglist.trigger("contentChanged"))},10)},this.pollUsers=function(){t.userlist.find("li").each(function(e,n){var o=$(n).text();if(!(o in t.color_map)){var a=t.colors[t.user_count];t.color_map[o]=a}$(n).find("span").prop("style","color:"+t.color_map[o])})},this.pollMessages=function(){t.msglist.find("div").each(function(e,n){$(n).prop("style","white-space:pre-wrap;background-color:#ECECEC;margin:5px 0;padding:5px;border-radius:10px;");var a=$(n).find("span > span").text();t.emojis.forEach(function(e,n){a=a.replace(new RegExp("("+e.value+")(?:(?!</))(s)?","gu"),"<i class='em "+e.css+"'>"+e.value+"</i>")});var i=a.match(o);if(null==i&&(i=[]),i.length>0){var s=void 0==i[3]?"<a href='http://$&' target='_blank'>$&</a>":"<a href='$&' target='_blank'>$&</a>";a=a.replace(o,s)}$(n).find("span > span").html(a)}),t.msglist.find("div span > h3 > span").each(function(e,n){var o=$(n).text().replace(":","");$(n).prop("style","font-weight:bold;color:"+t.color_map[o])})},this.checkEnabled=function(){t.settings.get("enabled_modules",function(e){var o;o=void 0==e.enabled_modules||e.enabled_modules.chatter.enabled,t.enabled!=o&&(t.enabled=o,t.enabled?n&&(t.loaded?t.update():t.setup()):(clearInterval(t.updateloop),s.log("Plato Enhancement Suite: Chatter is not running!")))})},this.info=function(){return{name:"Chatter",version:t.VERSION,is_loaded:t.loaded&&t.enabled}},this.dev=function(e){dev=e};var s={log:function(e){dev&&console.log(e)}}},c=new Chatter;module.exports.start=c.start,module.exports.getInfo=c.info,module.exports.dev=c.dev;